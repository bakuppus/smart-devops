YUI.add("moodle-atto_image-button",function(e,t){var i={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box",ALIGNSETTINGS:"atto_image_button"},n={INPUTURL:"."+i.INPUTURL},s=[{name:"verticalAlign",str:"alignment_top",value:"text-top",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_middle",value:"middle",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_bottom",value:"text-bottom",margin:"0 0.5em",isDefault:!0},{name:"float",str:"alignment_left",value:"left",margin:"0 0.5em 0 0"},{name:"float",str:"alignment_right",value:"right",margin:"0 0 0 0.5em"}],a=/\d+%/,o="atto_image",l='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_image").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this)},_handleDragDrop:function(t){var i=this,n=this.get("host"),s=e.Handlebars.compile(l);if(n.saveSelection(),(t=t._event).dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length&&/^image\//.test(t.dataTransfer.files[0].type)){var a,r,h,g=n.get("filepickeroptions").image,m=void 0===g.savepath?"/":g.savepath,u=new FormData,d=new XMLHttpRequest,c=Object.keys(g.repositories);t.preventDefault(),t.stopPropagation(),u.append("repo_upload_file",t.dataTransfer.files[0]),u.append("itemid",g.itemid);for(var I=0;I<c.length;I++)if("upload"===g.repositories[c[I]].type){u.append("repo_id",g.repositories[c[I]].id);break}return u.append("env",g.env),u.append("sesskey",M.cfg.sesskey),u.append("client_id",g.client_id),u.append("savepath",m),u.append("ctx_id",g.context.id),a=(new Date).getTime(),r="moodleimage_"+Math.round(1e5*Math.random())+"-"+a,n.focus(),n.restoreSelection(),h=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",o),id:r}),n.insertContentAtFocusPoint(h),i.markUpdated(),d.onreadystatechange=function(){var t,n,a,o,l=i.editor.one("#"+r);if(4===d.readyState)if(200===d.status){if(t=JSON.parse(d.responseText)){if(t.error)return l&&l.remove(!0),new M.core.ajaxException(t);n=t,t.event&&"fileexists"===t.event&&(n=t.newfile),a=s({url:n.url,presentation:!0}),o=e.Node.create(a),l?l.replace(o):i.editor.appendChild(o),i.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),l&&l.remove(!0)},d.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),d.send(u),!1}},_handleClick:function(e){var t=e.target,i=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==i&&this.get("host").setSelection(i)},_displayDialogue:function(){(this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection)&&(this._rawImageDimensions=null,this.getDialogue({headerContent:M.util.get_string("imageproperties",o),width:"480px",focusAfterHide:!0,focusOnShowSelector:n.INPUTURL}).set("bodyContent",this._getDialogueContent()).show())},_loadPreviewImage:function(e){var t=new Image,n=this;t.onerror=function(){n._form.one("."+i.IMAGEPREVIEW).setStyles({display:"none"}),n.getDialogue().centerDialogue()},t.onload=function(){var e,t,s,o,l;n._rawImageDimensions={width:this.width,height:this.height},""===(t=(e=n._form.one("."+i.INPUTWIDTH)).get("value"))&&(e.set("value",this.width),t=""+this.width),""===(s=(e=n._form.one("."+i.INPUTHEIGHT)).get("value"))&&(e.set("value",this.height),s=""+this.height),(e=n._form.one("."+i.IMAGEPREVIEW)).setAttribute("src",this.src),e.setStyles({display:"inline"}),e=n._form.one("."+i.INPUTCONSTRAIN),t.match(a)&&s.match(a)?e.set("checked",t===s):(0===this.width&&(this.width=1),0===this.height&&(this.height=1),o=Math.round(1e3*parseInt(t,10)/this.width),l=Math.round(1e3*parseInt(s,10)/this.height),e.set("checked",o===l)),n._autoAdjustSize(n),n.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var t=e.Handlebars.compile('<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>'),n=this.get("host").canShowFilepicker("image"),a=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:i,component:o,showFilepicker:n,alignments:s}));return this._form=a,this._applyImageProperties(this._form),this._form.one("."+i.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+i.IMAGEPRESENTATION).set("checked","checked"),this._form.one("."+i.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+i.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+i.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+i.INPUTCONSTRAIN).on("change",function(e){e.target.get("checked")&&this._autoAdjustSize(e)},this),this._form.one("."+i.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+i.INPUTSUBMIT).on("click",this._setImage,this),n&&this._form.one("."+i.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image",this._filepickerCallback,this)},this),a},_autoAdjustSize:function(e,t){t=t||!1;var n,s,o=this._form.one("."+i.INPUTWIDTH),l="width",r=this._form.one("."+i.INPUTHEIGHT),h="height",g=this._form.one("."+i.INPUTCONSTRAIN),m=o.get("value"),u=r.get("value"),d=this._form.one("."+i.IMAGEPREVIEW);if(this._rawImageDimensions)if(""===m&&(m=this._rawImageDimensions[l],o.set("value",m),m=o.get("value")),d.setStyles({width:null,height:null}),g.get("checked")){var c;if(t)c=o,o=r,r=c,c=l,l=h,h=c,c=m,m=u,u=c;m.match(a)?(u=m,n=parseInt(m,10),s=this._rawImageDimensions.width/100*n,d.setStyle("width",s),s=this._rawImageDimensions.height/100*n,d.setStyle("height",s)):(u=Math.round(m/this._rawImageDimensions[l]*this._rawImageDimensions[h]),t?d.setStyles({width:u,height:m}):d.setStyles({width:m,height:u})),r.set("value",u)}else m.match(a)?(n=parseInt(m,10),s=this._rawImageDimensions.width/100*n,d.setStyle("width",s+"px")):d.setStyle("width",m+"px"),u.match(a)?(n=parseInt(u,10),s=this._rawImageDimensions.height/100*n,d.setStyle("height",s+"px")):d.setStyle("height",u+"px")},_filepickerCallback:function(e){""!==e.url&&(this._form.one("."+i.INPUTURL).set("value",e.url),this._form.one("."+i.INPUTWIDTH).set("value",""),this._form.one("."+i.INPUTHEIGHT).set("value",""),this._loadPreviewImage(e.url))},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),n=e.one("."+i.IMAGEPREVIEW);if(!1===t)return n.setStyle("display","none"),void s.some(function(t){return!!t.isDefault&&(e.one("."+i.INPUTALIGNMENT).set("value",t.value),!0)},this);t.align&&e.one("."+i.INPUTALIGNMENT).set("value",t.align),t.customstyle&&e.one("."+i.INPUTCUSTOMSTYLE).set("value",t.customstyle),t.width&&e.one("."+i.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+i.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+i.INPUTALT).set("value",t.alt),t.src&&(e.one("."+i.INPUTURL).set("value",t.src),this._loadPreviewImage(t.src)),t.presentation&&e.one("."+i.IMAGEPRESENTATION).set("checked","checked"),this._autoAdjustSize()},_getSelectedImageProperties:function(){var e,t,i,n,s={src:null,alt:null,width:null,height:null,align:"",presentation:!1},o=this.get("host").getSelectedNodes();return o&&(o=o.filter("img")),o&&o.size()?(n=this._removeLegacyAlignment(o.item(0)),this._selectedImage=n,i=n.getAttribute("style"),s.customstyle=i,(e=n.getAttribute("width")).match(a)||(e=parseInt(e,10)),(t=n.getAttribute("height")).match(a)||(t=parseInt(t,10)),0!==e&&(s.width=e),0!==t&&(s.height=t),this._getAlignmentPropeties(n,s),s.src=n.getAttribute("src"),s.alt=n.getAttribute("alt")||"",s.presentation="presentation"===n.get("role"),s):(this._selectedImage=null,!1)},_getAlignmentPropeties:function(e,t){var i;!s.some(function(n){var s=this._getAlignmentClass(n.value);return e.hasClass(s)?(t.align=n.value,!0):(n.isDefault&&(i=n.value),!1)},this)&&i&&(t.align=i)},_urlChanged:function(){var e=this._form.one("."+i.INPUTURL);""!==e.get("value")&&this._loadPreviewImage(e.get("value"))},_setImage:function(t){var n,s=this._form,o=s.one("."+i.INPUTURL).get("value"),r=s.one("."+i.INPUTALT).get("value"),h=s.one("."+i.INPUTWIDTH).get("value"),g=s.one("."+i.INPUTHEIGHT).get("value"),m=this._getAlignmentClass(s.one("."+i.INPUTALIGNMENT).get("value")),u=s.one("."+i.IMAGEPRESENTATION).get("checked"),d=s.one("."+i.INPUTCONSTRAIN).get("checked"),c=s.one("."+i.INPUTCUSTOMSTYLE).get("value"),I=[],_=this.get("host");if(t.preventDefault(),!this._updateWarning()){if(_.focus(),""!==o){if(this._selectedImage?_.setSelection(_.getSelectionFromNode(this._selectedImage)):_.setSelection(this._currentSelection),d&&I.push(i.RESPONSIVE),I.push(m),!h.match(a)&&isNaN(parseInt(h,10)))return void s.one("."+i.INPUTWIDTH).focus();if(!g.match(a)&&isNaN(parseInt(g,10)))return void s.one("."+i.INPUTHEIGHT).focus();n=e.Handlebars.compile(l)({url:o,alt:r,width:h,height:g,presentation:u,customstyle:c,classlist:I.join(" ")}),this.get("host").insertContentAtFocusPoint(n),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()}},_removeLegacyAlignment:function(t){return t.getStyle("margin")?(s.some(function(i){if(t.getStyle(i.name)!==i.value)return!1;var n=e.Node.create("<div>");return n.setStyle("margin",i.margin),t.getStyle("margin")===n.getStyle("margin")&&(t.addClass(this._getAlignmentClass(i.value)),t.setStyle(i.name,null),t.setStyle("margin",null),!0)},this),t):t},_getAlignmentClass:function(e){return i.ALIGNSETTINGS+"_"+e},_updateWarning:function(){var e=this._form,t=!0,n=e.one("."+i.INPUTALT).get("value"),s=e.one("."+i.IMAGEPRESENTATION).get("checked");return""!==n||s?(e.one("."+i.IMAGEALTWARNING).setStyle("display","none"),e.one("."+i.INPUTALT).setAttribute("aria-invalid",!1),e.one("."+i.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),t=!1):(e.one("."+i.IMAGEALTWARNING).setStyle("display","block"),e.one("."+i.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+i.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),t=!0),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
